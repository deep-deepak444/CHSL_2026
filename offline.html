<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Study - Offline</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="offline-page">

  <div class="countdown-bar">
    рд╕рдордп рдмреАрдд рд░рд╣рд╛ рд╣реИ... тП│ <span id="countdown">Loading...</span>
  </div>

  <div class="action-bar">
    <span>ЁЯМР рдЕрдкрдиреЗ рдЗрдВрдЯрд░рдиреЗрдЯ рдХрдиреЗрдХреНрд╢рди рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ</span>
    <button id="retry-btn">Try Again</button>
  </div>

  <div class="main-content">
    <h3 class="content-heading">рдЕрдкрдиреА рдкрдврд╝рд╛рдИ рдЬрд╛рд░реА рд░рдЦреЗрдВ</h3>
    <div class="cached-list" id="cached-list">
      <p class="info-message">рд╕реЗрд╡ рдХрд┐рдП рд╣реБрдП рдХреНрд╡рд┐рдЬрд╝ рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...</p>
    </div>
  </div>

    <script>
    // --- рд▓реЙрдЬрд┐рдХ 1: рдХрд╛рдЙрдВрдЯрдбрд╛рдЙрди ---
    function startCountdown() {
      const countdownEl = document.getElementById('countdown');
      try {
        const userData = JSON.parse(localStorage.getItem('deepStudyUser'));
        if (!userData || !userData.examDate) {
          countdownEl.textContent = "рдкрд░реАрдХреНрд╖рд╛ рдХреА рддрд╛рд░реАрдЦ рд╕реЗрдЯ рдирд╣реАрдВ рд╣реИ";
          return;
        }
        
        const exam = new Date(userData.examDate);
        if (isNaN(exam)) {
          countdownEl.textContent = "рдЕрдорд╛рдиреНрдп рддрд╛рд░реАрдЦ";
          return;
        }

        const interval = setInterval(() => {
          const now = new Date();
          const diff = exam - now;

          if (diff <= 0) {
            countdownEl.textContent = "ЁЯОЙ Exam Day!";
            clearInterval(interval);
            return;
          }

          const d = Math.floor(diff / (1000 * 60 * 60 * 24));
          const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
          const m = Math.floor((diff / (1000 * 60)) % 60);
          const s = Math.floor((diff / 1000) % 60);
          countdownEl.textContent = `${d}d ${h}h ${m}m ${s}s`;
        }, 1000);
      } catch (e) {
        countdownEl.textContent = "рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛";
      }
    }

    // --- рд▓реЙрдЬрд┐рдХ 2: рдЯреНрд░рд╛рдИ рдЕрдЧреЗрди рдмрдЯрди ---
    document.getElementById('retry-btn').addEventListener('click', () => {
      window.location.reload();
	});

    // --- рд▓реЙрдЬрд┐рдХ 3: рдХреИрд╢ рдХреА рд╣реБрдИ рдлрд╛рдЗрд▓реЛрдВ рдХреА рд▓рд┐рд╕реНрдЯ рдмрдирд╛рдирд╛ (рдЕрдкрдбреЗрдЯреЗрдб) ---
    async function listCachedFiles() {
      const listContainer = document.getElementById('cached-list');
      listContainer.innerHTML = ''; 

      if (!('caches' in window)) {
        listContainer.innerHTML = "<p class='info-message'>рдЖрдкрдХрд╛ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдСрдлрд▓рд╛рдЗрди рд╕реНрдЯреЛрд░реЗрдЬ рдХреЛ рд╕рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдХрд░рддрд╛ред</p>";
        return;
      }

      try {
        const CACHE_NAME = 'quiz-files-v6';
        const cache = await caches.open(CACHE_NAME);
        const requests = await cache.keys();

        // --- рдпрд╣рд╛рдБ рдлрд┐рд▓реНрдЯрд░ рд▓реЙрдЬрд┐рдХ рдХреЛ рдмреЗрд╣рддрд░ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ ---
        const quizRequests = requests.filter(req => {
            const pathParts = new URL(req.url).pathname.split('/');
            // рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреЗрд╡рд▓ quiz рдлрд╛рдЗрд▓реЗрдВ рд╣реА рдЪреБрдиреА рдЬрд╛рдПрдВ
            // path рдРрд╕рд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП: /subjects/subject_name/quiz_file.json
            // рдЬреЛ 4 рднрд╛рдЧреЛрдВ рдореЗрдВ рдмрдВрдЯрд╛ рд╣реЛрддрд╛ рд╣реИ: ["", "subjects", "subject_name", "quiz_file.json"]
            return pathParts.length === 4 && pathParts[1] === 'subjects';
        });

        if (quizRequests.length === 0) {
          listContainer.innerHTML = "<p class='info-message'>рдЖрдкрдиреЗ рдЕрднреА рддрдХ рдХреЛрдИ рдХреНрд╡рд┐рдЬрд╝ рдирд╣реАрдВ рдЦреЗрд▓рд╛ рд╣реИ рдЬреЛ рдСрдлрд▓рд╛рдЗрди рдЙрдкрд▓рдмреНрдз рд╣реЛред</p>";
          return;
        }

        quizRequests.forEach(request => {
          const url = new URL(request.url);
          const pathParts = url.pathname.split('/');
          // pathParts[3] рд╣реИ quiz_file.json рдФрд░ pathParts[2] рд╣реИ subject_name
          const topicFile = pathParts[3].replace('.json', '');
          const subject = pathParts[2];

          const formattedTopic = topicFile.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          const formattedSubject = subject.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

          const link = document.createElement('a');
          link.className = 'cached-item';
          link.href = `quiz.html?subject=${subject}&topic=${topicFile}`;
          link.innerHTML = `
            ${formattedTopic}
            <span class="subject">рд╡рд┐рд╖рдп: ${formattedSubject}</span>
          `;
          listContainer.appendChild(link);
        });

      } catch (e) {
        listContainer.innerHTML = "<p class='info-message'>рдХреИрд╢ рдХреА рд╣реБрдИ рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрдеред</p>";
        console.error('Error listing cached files:', e);
      }
    }

    // --- рдкреЗрдЬ рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рд╕рднреА рдлрдВрдХреНрд╢рди рдЪрд▓рд╛рдирд╛ ---
    window.onload = () => {
      startCountdown();
      listCachedFiles();
    };

  </script>

</body>
</html>
